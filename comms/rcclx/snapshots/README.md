# RCCLX Snapshots

This directory contains the infrastructure for managing snapshots of rcclx static library builds across different ROCm versions.

## Storage Architecture

The snapshot system uses a **dual-storage approach** to optimize for both size and accessibility:

- **Artifacts (large `.a` files)**: Stored in Manifold bucket `rcclx_prebuilt_artifacts`
- **Headers and Metadata (small files)**: Stored in the repository for easy access, version control, and header/binary compatibility

### Manifold Structure (Artifacts)

## Manifold Structure (Artifacts)

Manifold stores the actual library binary files (`.a` files):

```
rcclx_prebuilt_artifacts/tree/
├── stable/               # Current stable snapshots
│   ├── 6.2/librcclx-dev.a
│   ├── 6.4/librcclx-dev.a
│   └── 7.0/librcclx-dev.a
├── last_stable/          # Previous stable snapshots (for rollback)
│   ├── 6.2/librcclx-dev.a
│   ├── 6.4/librcclx-dev.a
│   └── 7.0/librcclx-dev.a
└── archives/             # Backup snapshots (created before each snapshot operation)
    ├── backup_20250107_143000/
    │   ├── stable/
    │   │   ├── 6.2/librcclx-dev.a
    │   │   ├── 6.4/librcclx-dev.a
    │   │   └── 7.0/librcclx-dev.a
    │   └── last_stable/
    │       ├── 6.2/librcclx-dev.a
    │       ├── 6.4/librcclx-dev.a
    │       └── 7.0/librcclx-dev.a
    ├── backup_20250108_091500/
    │   └── ...
    └── ...
```

### Repository Structure (Metadata and Headers)

The repository stores both metadata files and header files to ensure header/binary compatibility:

```
snapshots/
├── scripts/           # Automation scripts
├── stable/           # Current stable snapshots (metadata + headers)
│   ├── 6.2/
│   │   ├── metadata.txt
│   │   └── rccl.h
│   ├── 6.4/
│   │   ├── metadata.txt
│   │   └── rccl.h
│   └── 7.0/
│       ├── metadata.txt
│       └── rccl.h
└── last-stable/      # Previous stable snapshots (metadata + headers)
    ├── 6.2/
    │   ├── metadata.txt
    │   └── rccl.h
    ├── 6.4/
    │   ├── metadata.txt
    │   └── rccl.h
    └── 7.0/
        ├── metadata.txt
        └── rccl.h
```
```

## Automatic Checksum Management

The snapshot system automatically manages SHA256 checksums without requiring manual updates to BUCK files. Here's how it works:

### Checksum Storage and Loading

1. **Metadata Files**: When a snapshot is created, checksums are stored in `metadata.txt` files:
   ```
   Snapshot created: 2025-01-15 14:30:00 UTC
   ROCm version: 6.4

   Checksums:
     sha1: f90de30eaf1159ec0ad5060d962e0220baf222f0
     sha256: bda119893a092d421e431edf7fe02340eacccb23ee514ddec5a7962e869f9bf9

   Commit Hashes:
     fbsource: abc123def456...
     rcclx: 789ghi012jkl...
   ```

2. **Checksums File**: The script generates `comms/rcclx/stable_checksums.bzl` from all metadata files:
   ```python
   # AUTO-GENERATED FILE - DO NOT EDIT MANUALLY
   # This file is generated by generate_checksums_bzl.py

   RCCLX_STABLE_CHECKSUMS = {
       "6.2": "bda119893a092d421e431edf7fe02340eacccb23ee514ddec5a7962e869f9bf9",
       "6.4": "abc123def456...",
       "7.0": "789ghi012jkl...",
   }

   RCCLX_LAST_STABLE_CHECKSUMS = {
       "6.2": "old_checksum_here...",
       "6.4": "old_checksum_here...",
       "7.0": "old_checksum_here...",
   }
   ```

3. **BUCK File Loading**: The BUCK file loads checksums dynamically:
   ```python
   load(":stable_checksums.bzl", "RCCLX_STABLE_CHECKSUMS", "RCCLX_LAST_STABLE_CHECKSUMS")

   manifold_get(
       name = "rcclx-stable-6.4-artifact",
       sha256 = RCCLX_STABLE_CHECKSUMS.get("6.4", "0" * 64),
       ...
   )
   ```

### Workflow

The entire process is automatic when creating snapshots:

```bash
./comms/rcclx/snapshots/scripts/create_snapshot_wrapper.sh --rocm-version 6.4
```

This command automatically:
1. Builds the library for ROCm 6.4
2. Calculates SHA256 checksum
3. Stores checksum in `snapshots/stable/6.4/metadata.txt`
4. Uploads artifact to Manifold
5. Regenerates `stable_checksums.bzl` from all metadata files
6. BUCK file automatically uses the new checksum on next build

**No manual checksum updates required!**

### Initial Setup

An empty `stable_checksums.bzl` is checked into the repository to allow BUCK files to load even before any snapshots exist:

```python
# Empty default file
RCCLX_STABLE_CHECKSUMS = {}
RCCLX_LAST_STABLE_CHECKSUMS = {}
```

When you create your first snapshot, this file is automatically populated with the calculated checksums.

The snapshot system allows you to:
1. Build rcclx with specific ROCm versions
2. Create tagged stable snapshots of the built archives (stored in Manifold)
3. Maintain version history with automatic rotation (stable → last-stable → archives)
4. Track metadata including commit hashes and dependencies (stored in repo)
5. Use pre-built stable snapshots for faster builds and validated releases

### Build Targets

There are three main build targets for rcclx:

- **`rcclx-dev`**: Builds rcclx from source (current top-of-tree)
  - Use when you're developing new features or testing changes
  - Always builds from the latest source code
  - Takes longer to build as it compiles everything from scratch

- **`rcclx-stable`**: Uses pre-built stable snapshots
  - Use for production deployments or when you need validated builds
  - Much faster as it skips compilation
  - Automatically selects the correct snapshot based on ROCm version constraint
  - Requires that a stable snapshot exists for the specified ROCm version

- **`rcclx-last-stable`**: Uses the previous stable snapshot (for rollback)
  - Use when issues are found with the current stable build
  - Provides a quick rollback to the last known good build
  - Automatically selects the correct snapshot based on ROCm version constraint
  - Requires that a last-stable snapshot exists for the specified ROCm version

## Usage

### Using Constraints for Automatic Target Selection (Recommended)

The simplest and recommended way to use rcclx is with the `-m` constraint flags, which automatically select the appropriate target:

```bash
# Build from source (default)
buck2 build @fbcode//mode/opt-amd-gpu fbcode//comms/rcclx:rcclx
buck2 build @fbcode//mode/opt-amd-gpu -m rcclx_dev fbcode//comms/rcclx:rcclx

# Use stable snapshot (fast, validated builds)
buck2 build @fbcode//mode/opt-amd-gpu -m rcclx_stable fbcode//comms/rcclx:rcclx

# Use last-stable snapshot (for rollback)
buck2 build @fbcode//mode/opt-amd-gpu -m rcclx_last_stable fbcode//comms/rcclx:rcclx
```

You can combine the rcclx constraint with ROCm version constraints:

```bash
# Use stable snapshot with ROCm 6.4
buck2 build @fbcode//mode/opt-amd-gpu -m rcclx_stable -m rocm64 fbcode//comms/rcclx:rcclx

# Use last-stable snapshot with ROCm 7.0
buck2 build @fbcode//mode/opt-amd-gpu -m rcclx_last_stable -m rocm70 fbcode//comms/rcclx:rcclx
```

### Using Stable Snapshots (rcclx-stable)

The `rcclx-stable` target allows you to use pre-built stable snapshots instead of building from source. This is faster and ensures you're using validated builds. The artifacts are automatically fetched from Manifold during the build:

```bash
# Use stable snapshot for ROCm 6.2
buck2 build @fbcode//mode/opt-amd-gpu -m ovr_config//third-party/rocm/constraints:6.2.1 fbcode//comms/rcclx:rcclx-stable

# Use stable snapshot for ROCm 6.4
buck2 build @fbcode//mode/opt-amd-gpu -m ovr_config//third-party/rocm/constraints:6.4.2 fbcode//comms/rcclx:rcclx-stable

# Use stable snapshot for ROCm 7.0
buck2 build @fbcode//mode/opt-amd-gpu -m ovr_config//third-party/rocm/constraints:7.0 fbcode//comms/rcclx:rcclx-stable
```

The build system automatically:
1. Selects the correct stable snapshot based on the ROCm version constraint
2. Downloads the artifact from Manifold at `rcclx_prebuilt_artifacts/tree/stable/<version>/librcclx-dev.a`
3. Uses the downloaded artifact for linking

If a stable snapshot doesn't exist in Manifold for the specified version, the build will fail with a clear error message.

### Using Last-Stable Snapshots (rcclx-last-stable)

The `rcclx-last-stable` target provides quick rollback capability by using the previous stable snapshot. Use this when issues are discovered with the current stable build. The artifacts are automatically fetched from Manifold during the build:

```bash
# Rollback to last-stable snapshot for ROCm 6.2
buck2 build @fbcode//mode/opt-amd-gpu -m ovr_config//third-party/rocm/constraints:6.2.1 fbcode//comms/rcclx:rcclx-last-stable

# Rollback to last-stable snapshot for ROCm 6.4
buck2 build @fbcode//mode/opt-amd-gpu -m ovr_config//third-party/rocm/constraints:6.4.2 fbcode//comms/rcclx:rcclx-last-stable

# Rollback to last-stable snapshot for ROCm 7.0
buck2 build @fbcode//mode/opt-amd-gpu -m ovr_config//third-party/rocm/constraints:7.0 fbcode//comms/rcclx:rcclx-last-stable
```

The build system automatically:
1. Selects the correct last-stable snapshot based on the ROCm version constraint
2. Downloads the artifact from Manifold at `rcclx_prebuilt_artifacts/tree/last_stable/<version>/librcclx-dev.a`
3. Uses the downloaded artifact for linking

This is particularly useful for quickly reverting to a known good state while investigating issues with the current stable build.

### Creating a Snapshot

The wrapper script `create_snapshot_wrapper.sh` provides a convenient way to build and create snapshots from the fbcode directory. It supports multiple modes and options.

#### Basic Usage

```bash
# From fbcode directory
cd /path/to/fbsource/fbcode

# Create a new snapshot for ROCm 6.4 (normal mode)
./comms/rcclx/snapshots/scripts/create_snapshot_wrapper.sh --rocm-version 6.4
```

#### Available Options

| Option | Description |
|--------|-------------|
| `--rocm-version <version>` | ROCm version (6.2, 6.4, or 7.0). Required for snapshot creation. |
| `--only-stable` | Update only stable, leave last-stable unchanged. |
| `--copy-stable` | Copy current stable to last-stable for all versions (no build). |
| `--rocm-versions <list>` | Comma-separated ROCm versions for --copy-stable mode (default: 6.2,6.4,7.0). |
| `--skip-backup` | Skip backup before making changes (not recommended). |
| `--help` | Show usage information. |

#### Examples

```bash
# Create a new snapshot for ROCm 6.2 (rotates stable to last-stable)
./comms/rcclx/snapshots/scripts/create_snapshot_wrapper.sh --rocm-version 6.2

# Create a new snapshot for ROCm 6.4 (rotates stable to last-stable)
./comms/rcclx/snapshots/scripts/create_snapshot_wrapper.sh --rocm-version 6.4

# Create a new snapshot for ROCm 7.0 (rotates stable to last-stable)
./comms/rcclx/snapshots/scripts/create_snapshot_wrapper.sh --rocm-version 7.0

# Create a new snapshot, only updating stable (last-stable unchanged)
./comms/rcclx/snapshots/scripts/create_snapshot_wrapper.sh --rocm-version 6.4 --only-stable

# Copy stable to last-stable for all ROCm versions (no build)
./comms/rcclx/snapshots/scripts/create_snapshot_wrapper.sh --copy-stable

# Copy stable to last-stable for specific ROCm versions
./comms/rcclx/snapshots/scripts/create_snapshot_wrapper.sh --copy-stable --rocm-versions 6.4,7.0

# Skip backup (not recommended, use only if you have a recent manual backup)
./comms/rcclx/snapshots/scripts/create_snapshot_wrapper.sh --rocm-version 6.4 --skip-backup
```

The wrapper script will:
1. Create a backup of all stable and last-stable artifacts before any changes
2. Build the rcclx-dev library with the specified ROCm version (unless using --copy-stable)
3. Run the snapshot creation script to update stable (and rotate to last-stable unless --only-stable)
4. Upload the artifact to Manifold at `rcclx_prebuilt_artifacts/tree/stable/<rocm_version>/`
5. Save metadata to the repo at `comms/rcclx/snapshots/stable/<rocm_version>/metadata.txt`
6. Regenerate `comms/rcclx/stable_checksums.bzl` from all metadata files

### Copying Stable to Last-Stable (--copy-stable)

The `--copy-stable` option allows you to copy the current stable snapshots to last-stable for all ROCm versions without building new snapshots. This is useful when you want to:

- Manually promote current stable to last-stable before making other changes
- Create a last-stable checkpoint without rebuilding the library
- Prepare for a rollback scenario

**Using the wrapper script (recommended):**

```bash
# Copy stable to last-stable for all ROCm versions (6.2, 6.4, 7.0)
./comms/rcclx/snapshots/scripts/create_snapshot_wrapper.sh --copy-stable

# Copy stable to last-stable for specific ROCm versions
./comms/rcclx/snapshots/scripts/create_snapshot_wrapper.sh --copy-stable --rocm-versions 6.4,7.0
```

**Using buck2 run directly:**

```bash
buck2 run fbcode//comms/rcclx/snapshots/scripts:create_snapshot -- \
    --snapshots-root $(pwd)/comms/rcclx/snapshots \
    --copy-stable

buck2 run fbcode//comms/rcclx/snapshots/scripts:create_snapshot -- \
    --snapshots-root $(pwd)/comms/rcclx/snapshots \
    --copy-stable \
    --rocm-versions 6.4,7.0
```

When using `--copy-stable`, the following operations occur:

1. **Backup Checkpoint**: Creates a backup of all stable and last-stable artifacts
2. **For each ROCm version**:
   - **Copy Stable to Last-Stable**: Copies current stable metadata/artifacts to last-stable (overwrites existing last-stable, stable remains unchanged)

### Updating Only Stable (--only-stable)

The `--only-stable` option allows you to update only the stable snapshot without affecting last-stable. This is useful when you want to:

- Update stable without promoting the previous stable to last-stable
- Fix an issue in stable without changing the rollback point (last-stable)
- Iterate on stable while keeping a known-good last-stable

**Using the wrapper script (recommended):**

```bash
# Update only stable for a specific ROCm version (last-stable unchanged)
./comms/rcclx/snapshots/scripts/create_snapshot_wrapper.sh --rocm-version 6.4 --only-stable
```

**Using buck2 run directly:**

```bash
buck2 run fbcode//comms/rcclx/snapshots/scripts:create_snapshot -- \
    --library /path/to/librcclx-dev.a \
    --rocm-version 6.4 \
    --snapshots-root $(pwd)/comms/rcclx/snapshots \
    --rcclx-repo $(pwd)/comms/rcclx \
    --header /path/to/rccl.h \
    --only-stable
```

When using `--only-stable`, the following operations occur:

1. **Backup Checkpoint**: Creates a backup of all stable and last-stable artifacts
2. **Skip Rotation**: The stable-to-last-stable rotation is skipped
3. **Update Stable**: New library, metadata, and header are installed to stable
4. **Last-Stable Unchanged**: The last-stable snapshot remains untouched

### What Happens During Snapshot Creation

When you run a snapshot build, the following operations occur in order:

1. **Build**: The rcclx library is built with the specified ROCm version constraints

2. **Backup Checkpoint**: Before making any changes, a backup of all stable and last-stable artifacts for all ROCm versions (6.2, 6.4, 7.0) is created in Manifold at `archives/backup_<timestamp>/`. This provides a recovery point if anything goes wrong.

3. **Rotate Current (if stable exists)**:
   - **Metadata**: Moved from `stable/<version>/` to `last-stable/<version>/` in repo (overwrites existing)
   - **Artifact**: Copied from Manifold `stable/<version>/` to `last_stable/<version>/` in Manifold (overwrites existing)

4. **Calculate Checksums**: SHA256 and SHA1 checksums are calculated for the newly built library

5. **Install New**:
   - **Artifact**: Newly built `librcclx-dev.a` uploaded to Manifold at `stable/<version>/`
   - **Metadata**: Created in repo at `stable/<version>/metadata.txt` with checksums

6. **Update Checksums File**: Automatically regenerates `comms/rcclx/stable_checksums.bzl` from all metadata files

The snapshot creation process is fully automated and requires no manual checksum management. The backup mechanism replaces the old archive rotation scheme, providing a simpler and more robust recovery option.

### Backup During Snapshot Creation

The create_snapshot script automatically creates a backup checkpoint before making any modifications. This backup includes:

- **Stable artifacts** for all ROCm versions (6.2, 6.4, 7.0)
- **Last-stable artifacts** for all ROCm versions (6.2, 6.4, 7.0)

The backup is stored in Manifold at:
```
rcclx_prebuilt_artifacts/tree/archives/backup_<timestamp>/
├── stable/
│   ├── 6.2/librcclx-dev.a
│   ├── 6.4/librcclx-dev.a
│   └── 7.0/librcclx-dev.a
└── last_stable/
    ├── 6.2/librcclx-dev.a
    ├── 6.4/librcclx-dev.a
    └── 7.0/librcclx-dev.a
```

The backup name (e.g., `backup_20260127_012000`) is logged during snapshot creation. If something goes wrong, you can restore from this backup:

```bash
buck2 run fbcode//comms/rcclx/snapshots/scripts:restore_manifold_artifacts -- \
    --backup-name backup_20260127_012000
```

To skip the backup step (not recommended), use the `--skip-backup` flag when running the create_snapshot script directly.

### Getting Checksums for BUCK File

The snapshot creation workflow automatically generates checksums and updates the BUCK file configuration. No manual intervention is required!

When you create a snapshot using the wrapper script:

```bash
cd /path/to/fbsource/fbcode
./comms/rcclx/snapshots/scripts/create_snapshot_wrapper.sh --rocm-version 6.4
```

The script automatically:
1. Builds the rcclx library for the specified ROCm version
2. Calculates SHA256 checksums for the built library
3. Stores checksums in `snapshots/stable/<version>/metadata.txt`
4. Uploads the artifact to Manifold
5. **Generates `comms/rcclx/stable_checksums.bzl`** from all metadata files

The BUCK file loads checksums from `stable_checksums.bzl`:

```python
load(":stable_checksums.bzl", "RCCLX_STABLE_CHECKSUMS")

manifold_get(
    name = "rcclx-stable-6.4-artifact",
    ...
    sha256 = RCCLX_STABLE_CHECKSUMS.get("6.4", "0" * 64),
    ...
)
```

This approach eliminates manual checksum management - the checksums are automatically read from metadata files and applied to BUCK targets.

**Manual Checksum Regeneration (if needed)**

If you need to regenerate `stable_checksums.bzl` manually:

```bash
buck2 run fbcode//comms/rcclx/snapshots/scripts:generate_checksums_bzl -- \
    --snapshots-root "$(pwd)/comms/rcclx/snapshots" \
    --output "$(pwd)/comms/rcclx/stable_checksums.bzl"
```

### Accessing Artifacts from Manifold

To download a pre-built artifact from Manifold, you can use the Manifold API or command-line tools:

```python
from manifold.clients.python import ManifoldClient
from datetime import timedelta
import io

# Download stable artifact for ROCm 6.4
async def download_artifact():
    with ManifoldClient(bucket="rcclx_prebuilt_artifacts", apiKey="rcclx_prebuilt_artifacts-key") as client:
        buffer = io.BytesIO()
        await client.get(
            path="tree/stable/6.4/librcclx-dev.a",
            output=buffer,
            timeout=timedelta(seconds=600),
        )

        # Save to local file
        with open("librcclx-dev.a", "wb") as f:
            f.write(buffer.getvalue())
```

### Snapshot Metadata

Each stable snapshot includes a `metadata.txt` file with information about the build:

```
Snapshot created: 2025-01-15 14:30:00 UTC
ROCm version: 6.4

Commit Hashes:
  fbsource: abc123def456...
  rcclx: 789ghi012jkl...
```

This metadata allows you to trace each snapshot back to its exact source code state.

## Directory Purposes

- **scripts/**: Contains automation scripts used by the build system
  - `create_snapshot.py`: Main script that handles snapshot creation and rotation
  - `backup_manifold_artifacts.py`: Script to backup stable/last-stable artifacts in Manifold
  - `restore_manifold_artifacts.py`: Script to restore artifacts from a Manifold backup

- **stable/**: Contains the current stable snapshot for each ROCm version
  - This is where you should find the latest validated builds
  - Each subdirectory contains the metadata and header files

- **last-stable/**: Contains the previous stable snapshot for each ROCm version
  - Provides a quick rollback option if issues are found with the current stable
  - Automatically populated when creating a new stable snapshot

## Example Workflow

1. Developer makes changes to rcclx
2. Changes are tested and validated
3. Run snapshot build for ROCm 6.4:
   ```bash
   cd /path/to/fbsource/fbcode
   ./comms/rcclx/snapshots/scripts/create_snapshot_wrapper.sh --rocm-version 6.4
   ```
4. The snapshot system:
   - Creates a backup of all stable and last-stable artifacts to `archives/backup_<timestamp>/` in Manifold
   - Moves current stable to `last-stable/6.4/` (metadata in repo, artifact in Manifold)
   - Installs new build to `stable/6.4/` in Manifold
   - Creates metadata file with commit hashes in repo

## Additional Scripts

### Backing Up Manifold Artifacts

To create a backup of all stable and last-stable artifacts within Manifold to an archives backup path:

```bash
# Backup all ROCm versions within Manifold
buck2 run fbcode//comms/rcclx/snapshots/scripts:backup_manifold_artifacts

# Backup specific ROCm versions
buck2 run fbcode//comms/rcclx/snapshots/scripts:backup_manifold_artifacts -- \
    --rocm-versions 6.2,6.4
```

The backup creates a timestamped directory in Manifold archives:
```
rcclx_prebuilt_artifacts/tree/archives/
└── backup_20260127_012000/
    ├── stable/
    │   ├── 6.2/librcclx-dev.a
    │   ├── 6.4/librcclx-dev.a
    │   └── 7.0/librcclx-dev.a
    └── last_stable/
        ├── 6.2/librcclx-dev.a
        ├── 6.4/librcclx-dev.a
        └── 7.0/librcclx-dev.a
```

The script prints the backup path name (e.g., `backup_20260127_012000`) which you can use to restore later.

### Restoring Artifacts from Backup

To restore artifacts from a backup location in Manifold:

```bash
# Restore both stable and last_stable from a backup (default)
buck2 run fbcode//comms/rcclx/snapshots/scripts:restore_manifold_artifacts -- \
    --backup-name backup_20260127_012000

# Dry run to see what would be restored
buck2 run fbcode//comms/rcclx/snapshots/scripts:restore_manifold_artifacts -- \
    --backup-name backup_20260127_012000 \
    --dry-run

# Restore only stable artifacts
buck2 run fbcode//comms/rcclx/snapshots/scripts:restore_manifold_artifacts -- \
    --backup-name backup_20260127_012000 \
    --stages stable

# Restore only last_stable artifacts
buck2 run fbcode//comms/rcclx/snapshots/scripts:restore_manifold_artifacts -- \
    --backup-name backup_20260127_012000 \
    --stages last_stable

# Restore specific ROCm versions
buck2 run fbcode//comms/rcclx/snapshots/scripts:restore_manifold_artifacts -- \
    --backup-name backup_20260127_012000 \
    --rocm-versions 6.2,6.4
```

### Disaster Recovery Workflow

If Manifold artifacts are lost or corrupted, use this workflow:

1. **If you have a Manifold backup**:
   ```bash
   # Restore from backup
   buck2 run fbcode//comms/rcclx/snapshots/scripts:restore_manifold_artifacts -- \
       --backup-name backup_20260127_012000
   ```

2. **If you need to recreate from scratch**:
   ```bash
   # Rebuild and create new snapshots for each ROCm version
   ./comms/rcclx/snapshots/scripts/create_snapshot_wrapper.sh --rocm-version 6.2
   ./comms/rcclx/snapshots/scripts/create_snapshot_wrapper.sh --rocm-version 6.4
   ./comms/rcclx/snapshots/scripts/create_snapshot_wrapper.sh --rocm-version 7.0
   ```

## Notes

- **Artifacts** (.a files) are stored in Manifold to avoid bloating the repository with large binary files
- **Metadata** (metadata.txt) and **headers** (rccl.h) are stored in the repository for easy access and version control
- Each ROCm version maintains its own independent snapshot history
- The snapshot system is designed to work with the existing rcclx-dev build target
- All snapshot operations create a backup checkpoint before making any modifications
- Backups are stored in Manifold at `archives/backup_<timestamp>/` and can be used for full restoration
- The backup mechanism replaces the old per-version archive rotation, providing simpler and more robust recovery
- Always use `--dry-run` first when running restore operations to verify what changes will be made
